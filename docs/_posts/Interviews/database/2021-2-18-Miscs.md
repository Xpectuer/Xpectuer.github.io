---
layout: post
categories: database
tag: database
title: "MySQL杂七杂八面试题"
author: noobi
date: 2021-02-18
---



# 数据库杂项Miscs

### 约束类型

- 主键PK （Primary Key）
- 唯一约束（Unique）
- 检查约束（用户可以自定义）
- 非空约束
- 外键（Foreign Key）约束

### 视图？游标？

- 视图（View）：从数据库的基本表中通过查询选取出来的数据组成的**虚拟表**（数据库中存放视图的定义）。可以对其进行增/删/改/查等操作。视图是对若干张基本表的引用，一张虚表，查询语句执行的结果，不存储具体的数据（基本表数据发生了改变，视图也会跟着改变）；可以跟基本表一样，进行增删改查操作(ps:增删改操作有条件限制)；如连表查询产生的视图无法进行，对视图的增删改会影响原表的数据。好处：
  - 通过只给用户访问视图的权限，保证数据的**安全性**；
  - **简化**复杂的SQL操作，隐藏数据的复杂性（比如复杂的连接）；
- 游标（Cursor）：用于定位在查询返回的**结果集的特定行**，以对特定行进行操作。使用游标可以方便地对结果集进行移动遍历，根据需要滚动或对浏览/修改任意行中的数据。主要用于交互式应用。



### InnoDB与MyISAM

- InnoDB支持事务
- MyISAM只支持表级锁，而InnoDB支持行级锁，提高并发操作的性能；
- InnoDB**支持外键**
- MyISAM崩溃后发生损坏的概率较高（没有redo log），恢复速度较慢，从binlog缓慢恢复
- MyISAM支持压缩表和空间数据索引，InnoDB需要更多的内存和储存
- InnoDB支持在线**热备份**

#### 场景

- MyISAM管理非事务表（即基本没有并发修改的需求）。

  提供高速存储和检索（执行速度比InnoDB更快），全文搜索能力。

  表较小，或者只读数据，MyISAM可选项

- InnoDB支持事务，并发情况下具有良好性能，基本可以替代MyISAM

#### 热备份

- 热备份：数据库
- 冷备份：数据库正常关闭后，将关键性文件复制到另一位置的备份方式。优点操作简单快速，恢复简单。



## 优化

### 查询优化

> 慢查询日志，所有执行时间超过long_query_time的SQL语句日志
>
> 通过日志可以发现IO时间长和索引失效的SQL

> explain：得到表的读取顺序、数据读取操作的操作类型、哪些索引可以使用、哪些被实际使用、表之间的引用以及被扫描的行数等问题；

- 尽量避免``!= < >``等操作符或对字段进行null值判断，否则索引将会失效进行全表扫描
- 只返回必要的列，将高频查询列放在索引上
- limit语句返回必要的行
- 减少长事务、分解长事务为短事务
  - 有利于查询缓存
  - 有利于undo log的空间紧凑
  - 减少IO
  - 减少锁竞争



### 表结构的优化

- 设计时遵循三大范式
- 合适的数据类型，尽量不要存NULL字段在可能的索引字段上
- 水平切分（sharding）：将一张表利用哈希取模，切到不同的单机数据库中，构建成分布式数据库。
- 垂直切分：将大字段独立放入一个表，把经常使用的字段放在一张表中。



### OS级别的优化

- 增大TCP缓冲区，优化页面大小、优化TCP accept队列大小...
- MySQL配置文件优化：缓存池大小和个数设置



### 硬件优化

- SSD
- CPU：多核高频
- 内存：大内存



## 分布式数据库

### 主从复制

Replication主从复制指可以从MySQL数据库主服务器复制到一个或者多个从服务器，从服务器可以复制主服务器中的所有数据库或者特定数据库，或者特定的表。默认采用**异步模式**（发送binlog）



实现原理：

- 主服务器binlog dump线程：维护binlog的增删改日志
- 从服务器的IO线程：从主服务器读取binlog，写入本地Relay log（轮换日志）
- 从服务器SQL线程：负责读取Relay Log，解析出主服务器以及执行的数据更改，并在从服务器中重新执行（Relay），保证主从一致性。





### 读写分离

>  基本的原理是让主数据库处理事务性查询，而从数据库处理SELECT查询。

常见策略是设置主节点可读可写、从节点只读。

主从同步利用异步线程发送binlog实现

意义：

1. 增加冗余，保证高可用
2. 增加了机器的处理能力（锁竞争减少）
3. 最佳实践是在**读操作为主的场景**
4. 降低单个服务器磁盘的IO频率，提高单个机器的IO性能




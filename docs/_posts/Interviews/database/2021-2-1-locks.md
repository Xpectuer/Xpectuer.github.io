---
layout: post
categories: database
title: "数据库的锁"
author: noobi
date: 2021-02-01
---
# 数据库的锁

### 写在前面

数据库锁，包括各种并发程序，锁的设计的初衷是处理并发问题，具体来说，就是并发共享资源访问的问题。

根据锁的粒度，MySQL中可以分为全局锁、表级锁和行锁。

### 全局锁

全局锁是对整个数据库实例加锁。

MySQL提供了一个全局读锁的方法：

~~~mysql
Flush tables with read lock(FTWRL)
~~~

这个命令会使整个库处于只读状态。

其他的CUD语句以及DDL语句会被阻塞。



#### 应用

**全局锁的典型使用场景，就是做全库逻辑备份。** 

FTWRL确保了不会有其他线程对数据库做更新，然后对整库进行备份。



整库只读会有很多问题：

- 主库上备份，备份期间不能执行更新，业务基本就会停摆。
- 从库上备份，那么备份期间从库不能执行主库同步过来的binlog，导致**主从延迟**。



### 乐观锁和悲观锁

- 悲观锁：每次读取数据都加上锁，防止其他事务的修改；应用于**数据更新频繁的场景**
- 乐观锁：不会上锁，更新时判断一个事务期间有没有别的事务更新数据，如果被更新过，则失败重试；适用于**读多写少**的场景。
  - 加版本号或者时间戳，更新时同步更新字段
  - 先读取想要更新的字段或者所有字段，更新的时候比较一下是否被修改，字段没有变化就更新。

### 常见锁类型

- 排它锁（Exclusive Locks）：只允许**获得锁的事务**对数据进行读取和修改，不能再对该数据加锁。 

  ```mysql
  SELECT * FROM T WHERE ... FOR UPDATE
  ```

- 共享锁（Shared Locks）：只允许获得锁的事务读写，其他事务只能读。一旦S锁被获得，其他事务**只能获得S锁，不能获得X锁。**

  ~~~mysql
  SELECT * FROM T WHERE ... LOCK IN SHARE MODE
  ~~~

- 意向锁（Intention Locks）：

  InnoDB允许**行级锁与表级锁共存**，而意向锁就是其中一种**表锁**

  - 一个事务获得某**数据行**对象S锁之前，必须获得整个表的IS锁或更强的锁（IX锁）。
  - 一个事务获得某**数据行**对象X锁之前，必须获得整个表的IX锁。
  - 意向锁无法被用户操作，由引擎自动分配
  - IX/IS都是兼容的
  - **意义：不需要遍历所有行就可以得知当前表封锁情况。**

##### 锁的意义：

用于管理共享资源的并发访问，保证数据库的完整性和一致性。



### 封锁粒度

- 行级锁
- 表级锁

>  粒度越小，并发度越高，但是系统开销大（在IX/IS前需要消耗时间来判断锁）



### 三级封锁协议

- 一级：

  事务在修改数据前必须加X锁，**直到事务结束**。

  解决： 丢失修改

- 二级

  以一级为基础，读取数据前加S锁，**读完后释放**。

  解决：脏读

- 三级

  二级为基础，读取数据前加S锁，**直到事务结束释放**。

  解决：不可重复读

### 两段锁协议

加锁与解锁必须成对存在，事务一旦释放锁就不能申请新锁了。（防止死锁？）

可串行化调度，通过并发控制，使得并发执行的事务结果与某个串行执行的事务结果相同。（理想）

**两段锁协议是保证串行化调度的充分条件。**



### MVCC

多版本并发控制（Multi-Version Concurrency Control, MVCC）,是MySQL一种提升事务并发的机制。

MVCC在每行记录后面都会保存两个隐藏的列，用来储存**创建版本号和删除版本号**。

- 创建版本号：一个数据行被创建时的事务版本号（**事务版本号**：事务开始时的系统版本号；系统版本号：每开始一个新的事务，系统版本号就会自动递增）

- 删除版本号：删除操作时的版本号：

- 查询时的版本号判断：

  - 删除版本号**未定义或大于**当前事务版本号（删除操作是在当前事务启动之后做的）；

    且&&

  - 创建版本号**小于等于**当前事务版本号（创建操作是事务完成或者事务启动前完成的）

意义：通过**版本号迭代（CAS或其他atomic原子操作）实现乐观锁**，减少了锁的争用，**提升系统事务并发**；可以实现**提交读和可重复读**两种隔离级别，未提交读无需使用MVCC

##### 快照读与当前读

MVCC可以读取undo log中的数据，来减少加锁带来的开销：

~~~mysql
select * from T ...;
~~~



